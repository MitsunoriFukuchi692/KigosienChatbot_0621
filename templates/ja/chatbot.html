document.addEventListener('DOMContentLoaded', () => {
  // DOM 要素取得
  const micBtn = document.getElementById('micBtn');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatWindow = document.getElementById('chatWindow');
  const templateButtons = document.querySelectorAll('.template-btn');

  // Speech Recognition 初期化
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition, recognizing = false;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.addEventListener('start', () => {
      recognizing = true;
      micBtn.textContent = '🎙️…';
    });

    recognition.addEventListener('end', () => {
      recognizing = false;
      micBtn.textContent = '🎤';
    });

    recognition.addEventListener('result', (event) => {
      const transcript = event.results[0][0].transcript.trim();
      chatInput.value = transcript;
      chatInput.focus();
    });

    micBtn.addEventListener('click', () => {
      if (recognizing) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });
  } else {
    micBtn.disabled = true;
    console.warn('このブラウザは Speech Recognition API に対応していません');
  }

  // テンプレートボタン処理
  templateButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const msg = btn.dataset.msg;
      chatInput.value = msg;
      chatInput.focus();
    });
  });

  // メッセージ送信処理
  async function sendMessage() {
    const userText = chatInput.value.trim();
    if (!userText) return;

    appendMessage('user', userText);
    chatInput.value = '';

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: userText })
      });
      const data = await response.json();
      appendMessage('bot', data.reply);
    } catch (err) {
      console.error(err);
      appendMessage('bot', 'エラーが発生しました。');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // メッセージ表示
  function appendMessage(who, text) {
    const msg = document.createElement('div');
    msg.className = `message ${who}`;
    msg.innerHTML = `<p>${text}</p>`;
    chatWindow.appendChild(msg);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
});
