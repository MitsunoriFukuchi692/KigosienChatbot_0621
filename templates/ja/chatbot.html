document.addEventListener('DOMContentLoaded', () => {
  // DOM è¦ç´ å–å¾—
  const micBtn = document.getElementById('micBtn');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatWindow = document.getElementById('chatWindow');
  const templateButtons = document.querySelectorAll('.template-btn');

  // Speech Recognition åˆæœŸåŒ–
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition, recognizing = false;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.addEventListener('start', () => {
      recognizing = true;
      micBtn.textContent = 'ðŸŽ™ï¸â€¦';
    });

    recognition.addEventListener('end', () => {
      recognizing = false;
      micBtn.textContent = 'ðŸŽ¤';
    });

    recognition.addEventListener('result', (event) => {
      const transcript = event.results[0][0].transcript.trim();
      chatInput.value = transcript;
      chatInput.focus();
    });

    micBtn.addEventListener('click', () => {
      if (recognizing) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });
  } else {
    micBtn.disabled = true;
    console.warn('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Speech Recognition API ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
  }

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
  templateButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const msg = btn.dataset.msg;
      chatInput.value = msg;
      chatInput.focus();
    });
  });

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
  async function sendMessage() {
    const userText = chatInput.value.trim();
    if (!userText) return;

    appendMessage('user', userText);
    chatInput.value = '';

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: userText })
      });
      const data = await response.json();
      appendMessage('bot', data.reply);
    } catch (err) {
      console.error(err);
      appendMessage('bot', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function appendMessage(who, text) {
    const msg = document.createElement('div');
    msg.className = `message ${who}`;
    msg.innerHTML = `<p>${text}</p>`;
    chatWindow.appendChild(msg);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
});
